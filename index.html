<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÇ‡∏Å‡∏î‡∏±‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ (Pro Gallery & Export + Backup)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>
    <style>
        :root { --red: #d32f2f; --green: #2e7d32; --blue: #1976d2; --bg: #f4f7f6; --dark: #333; --orange: #ff9800; }
        body { font-family: 'Tahoma', sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { background: white; padding: 10px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px dashed #ddd; padding-bottom: 10px; }
        .viewport { flex: 1; overflow-y: auto; background: white; position: relative; }
        .row { display: flex; align-items: flex-start; padding: 10px 15px; border-bottom: 1px solid #eee; transition: 0.2s; height: 140px; position: absolute; width: 100%; box-sizing: border-box; }
        .row:hover { background: #fffdfd; }
        .row.hidden-item { opacity: 0.5; background: #f9f9f9; }
        .gallery-container { display: flex; gap: 5px; overflow-x: auto; max-width: 350px; padding-bottom: 5px; margin-right: 15px; }
        .gallery-container::-webkit-scrollbar { height: 4px; }
        .gallery-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        .img-thumb { min-width: 80px; height: 110px; object-fit: cover; border-radius: 4px; cursor: zoom-in; border: 1px solid #ddd; flex-shrink: 0; }
        .shop-highlight { display: inline-block; background: #e3f2fd; color: #0d47a1; padding: 4px 10px; border-radius: 6px; font-weight: 900; font-size: 14px; border: 1px solid #bbdefb; margin-bottom: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .sku-badge { background: #333; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; cursor: copy; margin-top: 5px; display: inline-block; }
        .count-badge { margin-left: auto; background: var(--blue); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 13px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); white-space: nowrap; }
        .btn { padding: 8px 15px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; font-size: 13px; }
        .btn-red { background: var(--red); color: white; }
        .btn-green { background: var(--green); color: white; }
        .btn-grey { background: #555; color: white; }
        .btn-orange { background: var(--orange); color: white; }
        .btn-blue { background: var(--blue); color: white; } 
        select, input[type="text"], input[type="date"] { padding: 8px; border-radius: 6px; border: 1px solid #ccc; height: 35px; box-sizing: border-box; }
        .filter-bar { display: flex; gap: 10px; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 10px; flex-wrap: wrap; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 700px; padding: 20px; border-radius: 10px; max-height: 85vh; overflow-y: auto; position: relative; }
        .dup-card { border-left: 4px solid var(--red); background: #fffcfc; padding: 10px; margin-bottom: 8px; font-size: 13px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .dup-reason { display: inline-block; background: #ffebee; color: #c62828; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 11px; margin-bottom: 5px; }
        .hidden-mgr-row { display: flex; border-bottom: 1px solid #eee; padding: 10px 0; align-items: center; }
        .hidden-mgr-row:hover { background: #f9f9f9; }
        .img-viewer-content { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #fullImg { transition: transform 0.1s; max-height: 90vh; max-width: 90vw; border-radius: 5px; cursor: grab; }
        .nav-hint { position: absolute; bottom: 20px; color: white; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; font-size: 12px; pointer-events: none; }
        .bulk-bar { display: none; background: #fff3e0; padding: 8px 15px; border-radius: 8px; align-items: center; gap: 10px; margin-bottom: 5px; border: 1px solid #ffe0b2; }
        .backup-alert { display: none; background: #fff3cd; color: #856404; padding: 10px; text-align: center; border-bottom: 1px solid #ffeeba; font-weight: bold; justify-content: center; align-items: center; gap: 10px; }
        .select-all-header { position: sticky; top: 0; background: #fff; z-index: 10; padding: 8px 15px; border-bottom: 1px solid #ddd; font-size: 13px; display: flex; align-items: center; color: #555; font-weight: bold; }
        @media (max-width: 600px) { .filter-bar { justify-content: space-between; } .count-badge { width: 100%; text-align: center; margin-top: 5px; order: 10; } }
    </style>
</head>
<body>

<div id="hiddenMgrModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; color:var(--red);">üö´ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà <span id="totalHiddenCount" style="font-size:14px; color:#666; font-weight:normal;"></span></h3>
            <button class="btn btn-green" onclick="restoreSelectedHidden()">‚úÖ ‡πÄ‡∏•‡∏¥‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
        </div>
        <div style="background:#fff3e0; padding:10px; margin-bottom:10px; border-radius:5px; font-size:13px;">
            <label><input type="checkbox" id="selectAllHidden" onchange="toggleSelectAllHidden()"> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</label>
            <span id="hiddenSelCount" style="margin-left:15px; font-weight:bold; color:var(--red);"></span>
        </div>
        <div id="hiddenList" style="max-height: 60vh; overflow-y: auto;"></div>
        <div style="text-align:right; margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
            <button class="btn btn-grey" onclick="document.getElementById('hiddenMgrModal').style.display='none'">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
    </div>
</div>

<div id="setupModal" class="modal">
    <div class="modal-content">
        <h3>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡πá‡∏≠‡∏õ‡∏¢‡πà‡∏≠‡∏¢</h3>
        <div style="margin-bottom:15px; display:flex; gap:5px;">
            <input type="text" id="newMainShop" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å..." style="flex:1">
            <button class="btn btn-red" onclick="addMainShop()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô</button>
        </div>
        <div id="shopManagerList"></div>
        <button class="btn btn-grey" onclick="document.getElementById('setupModal').style.display='none'" style="width:100%; margin-top:15px;">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
    </div>
</div>

<div id="backupModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <h3>üíæ ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
        <p style="color:#666; font-size:13px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢</p>
        <div style="background:#f5f5f5; padding:15px; border-radius:8px; margin-bottom:15px;">
            <label><strong>‚è∞ ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</strong></label>
            <select id="backupInterval" onchange="saveBackupSettings()" style="width:100%; margin-top:5px;">
                <option value="0">‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</option>
                <option value="1">‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô</option>
                <option value="3">‡∏ó‡∏∏‡∏Å 3 ‡∏ß‡∏±‡∏ô</option>
                <option value="7">‡∏ó‡∏∏‡∏Å 7 ‡∏ß‡∏±‡∏ô (‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå)</option>
                <option value="30">‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏±‡∏ô (‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</option>
            </select>
        </div>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button class="btn btn-orange" onclick="createBackup()">üì• ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Backup)</button>
            <div style="position:relative;">
                <button class="btn btn-green" onclick="document.getElementById('restoreFile').click()" style="width:100%;">üì§ ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå (Restore)</button>
                <input type="file" id="restoreFile" accept=".json" hidden onchange="restoreBackup(this)">
            </div>
        </div>
        <hr>
        <div style="text-align:right;">
            <span id="lastBackupTime" style="font-size:11px; color:#999; margin-right:10px;"></span>
            <button class="btn btn-grey" onclick="document.getElementById('backupModal').style.display='none'">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>
</div>

<div id="dupModal" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--red); margin:0 0 10px 0;">üö´ ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥</h2>
        <p id="dupSummary" style="font-weight:bold;"></p>
        <div id="dupList"></div>
        <button class="btn btn-grey" onclick="document.getElementById('dupModal').style.display='none'" style="width:100%; margin-top:15px;">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button>
    </div>
</div>

<div id="imgModal" class="modal" onclick="closeGallery()">
    <div class="img-viewer-content" onclick="event.stopPropagation()">
        <img id="fullImg" onwheel="zoomImage(event)">
        <div class="nav-hint">üñ±Ô∏è ‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡∏π‡∏° | ‚¨ÖÔ∏è ‚û°Ô∏è ‡∏Å‡∏î‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÅ‡∏õ‡πâ‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏£‡∏π‡∏õ | ‡πÅ‡∏ï‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î</div>
    </div>
</div>

<div id="backupAlert" class="backup-alert">
    <span>‚ö†Ô∏è ‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</span>
    <button class="btn btn-orange" style="padding:4px 10px; font-size:12px;" onclick="openBackupModal()">‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ</button>
    <button style="background:none; border:none; cursor:pointer;" onclick="document.getElementById('backupAlert').style.display='none'">√ó</button>
</div>

<header>
    <div class="top-bar">
        <div style="display:flex; align-items:center; gap:10px;">
            <h2 style="margin:0; color:var(--dark);">üìö ‡πÇ‡∏Å‡∏î‡∏±‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ Pro</h2>
            <button class="btn btn-grey" onclick="openSetup()" style="font-size:11px;">‚öôÔ∏è ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
            <button class="btn btn-orange" onclick="openBackupModal()" style="font-size:11px;">üíæ Backup</button>
            <button class="btn btn-blue" onclick="openHiddenManager()" style="font-size:11px;">üö´ ‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="doExport()" class="btn btn-green">üì• Excel</button>
            <button onclick="clearDB()" class="btn btn-red">‚ö†Ô∏è ‡∏•‡πâ‡∏≤‡∏á</button>
        </div>
    </div>

    <div id="bulkBar" class="bulk-bar">
        <span id="selCount" style="font-weight:bold;">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        <button class="btn btn-grey" style="padding:4px 10px; font-size:11px;" onclick="bulkVisible(true)">üëÅÔ∏è ‡πÅ‡∏™‡∏î‡∏á</button>
        <button class="btn btn-grey" style="padding:4px 10px; font-size:11px;" onclick="bulkVisible(false)">üö´ ‡∏ã‡πà‡∏≠‡∏ô</button>
        <button class="btn btn-red" style="padding:4px 10px; font-size:11px;" onclick="bulkDelete()">üóëÔ∏è ‡∏•‡∏ö</button>
    </div>

    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; background:#eee; padding:10px; border-radius:8px;">
        <span style="font-weight:bold; font-size:13px;">üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</span>
        <select id="selMain" onchange="updateSubOptions()" style="width:150px;"></select>
        <select id="selSub" style="width:100px;"></select>
        <button class="btn btn-red" onclick="document.getElementById('fIn').click()">+ ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</button>
        <input type="file" id="fIn" hidden accept=".xlsx, .xls" onchange="handleImport(this)">
    </div>

    <div class="filter-bar">
        <span style="font-weight:bold;">üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏Å‡∏£‡∏≠‡∏á:</span>
        <select id="filterShop" onchange="render()" style="min-width:180px; font-weight:bold;">
            <option value="all">üè† ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        </select>
        <select id="filterStatus" onchange="render()" style="width:140px; color:#1976d2; font-weight:bold;">
            <option value="all">üëÅÔ∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option value="visible">‚úÖ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</option>
            <option value="hidden">üö´ ‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà (Hidden)</option>
        </select>
        <input type="date" id="filterDate" onchange="render()" title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏π‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î">
        <input type="text" id="srch" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ SKU..." style="flex:1;" oninput="render()">
        <span id="displayCount" class="count-badge">üì¶ ‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î...</span>
    </div>
</header>

<div class="viewport" id="vPort">
    <div class="select-all-header">
        <input type="checkbox" id="mainSelectAll" onchange="toggleSelectAllMain()" style="transform:scale(1.3); margin-right:10px;">
        <label for="mainSelectAll" style="cursor:pointer;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ</label>
    </div>
    <div id="canvas" style="position:relative;"></div>
</div>

<script>
    // --- ‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ GOOGLE SHEETS ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwQNk6DxuLcuSps3R8aY8X2Qwar6qCczQ8gA08Y4laz5OMM3-gN15nGcYk7ohGQiJxr/exec"; 

    async function syncToSheets(item) {
        try {
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' }, // ‡πÉ‡∏ä‡πâ text/plain ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ CORS
                body: JSON.stringify(item)
            });
            console.log("Synced to Sheets:", item.name);
        } catch (e) {
            console.error("Sync Error:", e);
        }
    }

    // --- 1. Database & State ---
    const db = new Dexie("StockWarehouseProV13_HiddenMgr"); 
    db.version(1).stores({ 
        items: "++id, mainUrl, name, sku, shopId, subId, isVisible, uploadDate, sortKey, hideDate", 
        settings: "id, data" 
    });

    let master = [];
    let filteredData = []; 
    let config = { shops: [], backupInterval: 0, lastBackup: null }; 
    let selectedIds = new Set();
    const R_HEIGHT = 140;
    let currentGalleryImgs = [];
    let currentImgIndex = 0;
    let currentZoom = 1;
    let hiddenItemsCache = [];
    let selectedHiddenIds = new Set();

    // --- 2. Initialization ---
    window.onload = async () => {
        const savedConfig = await db.settings.get("config");
        if(savedConfig) {
            config = savedConfig.data;
        } else {
            config = { 
                shops: [
                    { name: "‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏î‡∏≠‡∏∞‡πÄ‡∏ã‡∏ü", subs: ["‡∏ä‡πá‡∏≠‡∏õ 1", "‡∏ä‡πá‡∏≠‡∏õ 2"] },
                    { name: "‡∏£‡πâ‡∏≤‡∏ô‡∏õ‡∏±‡∏ì‡∏ç‡πå‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏Å‡πà‡∏≤", subs: ["‡∏ä‡πá‡∏≠‡∏õ 1"] },
                    { name: "‡∏£‡πâ‡∏≤‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢", subs: ["‡∏ä‡πá‡∏≠‡∏õ 1"] },
                    { name: "‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏ï‡∏π‡∏ô‡∏ó‡∏π‡πÄ‡∏î‡∏¢‡πå", subs: ["‡∏ä‡πá‡∏≠‡∏õ 1"] }
                ],
                backupInterval: 0,
                lastBackup: null
            };
            await db.settings.put({id: "config", data: config});
        }
        document.getElementById('backupInterval').value = config.backupInterval || 0;
        checkBackupStatus();
        initUI();
        reload();
        document.addEventListener('keydown', (e) => {
            if(document.getElementById('imgModal').style.display === 'flex') {
                if(e.key === "ArrowRight") navGallery(1);
                if(e.key === "ArrowLeft") navGallery(-1);
                if(e.key === "Escape") closeGallery();
            }
        });
    };

    function initUI() {
        const selMain = document.getElementById('selMain');
        selMain.innerHTML = config.shops.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        updateSubOptions();
        const filterShop = document.getElementById('filterShop');
        let opts = `<option value="all">üè† ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;
        config.shops.forEach(s => {
            opts += `<optgroup label="${s.name}">`;
            opts += `<option value="MAIN|${s.name}">üìÇ ${s.name} (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</option>`;
            s.subs.forEach(sub => {
                opts += `<option value="${s.name}|${sub}">‚îî‚îÄ‚îÄ ${sub}</option>`;
            });
            opts += `</optgroup>`;
        });
        filterShop.innerHTML = opts;
        if(config.lastBackup) {
            const d = new Date(config.lastBackup);
            document.getElementById('lastBackupTime').innerText = `Backup ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${d.toLocaleString()}`;
        }
    }

    function toggleSelectAllMain() {
        const isChecked = document.getElementById('mainSelectAll').checked;
        if(isChecked) {
            filteredData.forEach(item => selectedIds.add(item.id));
        } else {
            selectedIds.clear();
        }
        updateBulkBar();
        render();
    }

    function toggleSelect(id) {
        if(selectedIds.has(id)) selectedIds.delete(id);
        else selectedIds.add(id);
        updateBulkBar();
        const allSelected = filteredData.length > 0 && filteredData.every(item => selectedIds.has(item.id));
        document.getElementById('mainSelectAll').checked = allSelected;
    }

    function updateBulkBar() {
        const bar = document.getElementById('bulkBar');
        if(selectedIds.size > 0) {
            bar.style.display = 'flex';
            document.getElementById('selCount').innerText = `${selectedIds.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        } else {
            bar.style.display = 'none';
        }
    }

    async function openHiddenManager() {
        hiddenItemsCache = master.filter(i => i.isVisible === false);
        selectedHiddenIds.clear();
        document.getElementById('selectAllHidden').checked = false;
        document.getElementById('totalHiddenCount').innerText = `(‡∏°‡∏µ ${hiddenItemsCache.length.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
        renderHiddenList();
        document.getElementById('hiddenMgrModal').style.display = 'flex';
    }

    function renderHiddenList() {
        const container = document.getElementById('hiddenList');
        const countSpan = document.getElementById('hiddenSelCount');
        if(hiddenItemsCache.length === 0) {
            container.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà</div>';
            countSpan.innerText = '';
            document.getElementById('totalHiddenCount').innerText = `(‡∏°‡∏µ 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
            return;
        }
        container.innerHTML = hiddenItemsCache.map(item => `
            <div class="hidden-mgr-row">
                <input type="checkbox" style="transform:scale(1.2); margin:0 15px;" 
                    ${selectedHiddenIds.has(item.id) ? 'checked' : ''} 
                    onchange="toggleHiddenSelect(${item.id})">
                <img src="${item.mainUrl}" style="width:50px; height:70px; object-fit:cover; border-radius:4px; margin-right:10px;" onerror="this.style.display='none'">
                <div style="flex:1;">
                    <div style="font-weight:bold; font-size:13px;">${item.name}</div>
                    <div style="font-size:11px; color:#666;">
                        ‡∏£‡πâ‡∏≤‡∏ô: ${item.shopId} > ${item.subId} <br>
                        ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${formatDate(item.hideDate || new Date())}
                    </div>
                </div>
                <button class="btn btn-green" style="padding:5px 10px; font-size:11px;" onclick="unhideSingle(${item.id})">‡πÄ‡∏•‡∏¥‡∏Å‡∏ã‡πà‡∏≠‡∏ô</button>
            </div>
        `).join('');
        updateHiddenCount();
    }

    function toggleHiddenSelect(id) {
        if(selectedHiddenIds.has(id)) selectedHiddenIds.delete(id);
        else selectedHiddenIds.add(id);
        updateHiddenCount();
    }

    function toggleSelectAllHidden() {
        const isChecked = document.getElementById('selectAllHidden').checked;
        if(isChecked) {
            hiddenItemsCache.forEach(i => selectedHiddenIds.add(i.id));
        } else {
            selectedHiddenIds.clear();
        }
        renderHiddenList();
    }

    function updateHiddenCount() {
        const countSpan = document.getElementById('hiddenSelCount');
        countSpan.innerText = selectedHiddenIds.size > 0 ? `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ${selectedHiddenIds.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£` : '';
    }

    async function unhideSingle(id) {
        await db.items.update(id, { isVisible: true, hideDate: null });
        reload(); 
        hiddenItemsCache = hiddenItemsCache.filter(i => i.id !== id);
        document.getElementById('totalHiddenCount').innerText = `(‡∏°‡∏µ ${hiddenItemsCache.length.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
        renderHiddenList();
    }

    async function restoreSelectedHidden() {
        if(selectedHiddenIds.size === 0) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏•‡∏¥‡∏Å‡∏ã‡πà‡∏≠‡∏ô');
        if(confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏¥‡∏Å‡∏ã‡πà‡∏≠‡∏ô ${selectedHiddenIds.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
            await db.items.where('id').anyOf([...selectedHiddenIds]).modify({ isVisible: true, hideDate: null });
            reload();
            openHiddenManager();
        }
    }

    async function bulkVisible(status) {
        const updateData = { isVisible: status };
        if(status === false) updateData.hideDate = new Date().toISOString(); 
        else updateData.hideDate = null;
        await db.items.where('id').anyOf([...selectedIds]).modify(updateData);
        selectedIds.clear(); 
        reload(); 
        document.getElementById('bulkBar').style.display='none';
        document.getElementById('mainSelectAll').checked = false;
    }

    function openBackupModal() { document.getElementById('backupModal').style.display = 'flex'; }
    
    async function saveBackupSettings() {
        config.backupInterval = parseInt(document.getElementById('backupInterval').value);
        await db.settings.put({id: "config", data: config});
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    }

    function checkBackupStatus() {
        if (!config.backupInterval || config.backupInterval === 0) return;
        if (!config.lastBackup) {
            document.getElementById('backupAlert').style.display = 'flex';
            return;
        }
        const last = new Date(config.lastBackup);
        const now = new Date();
        const diffDays = Math.floor((now - last) / (1000 * 60 * 60 * 24));
        if (diffDays >= config.backupInterval) {
            document.getElementById('backupAlert').style.display = 'flex';
        }
    }

    async function createBackup() {
        const items = await db.items.toArray();
        const backupData = {
            timestamp: new Date().toISOString(),
            config: config,
            items: items
        };
        const blob = new Blob([JSON.stringify(backupData)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `StockBackup_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        config.lastBackup = new Date().toISOString();
        await db.settings.put({id: "config", data: config});
        document.getElementById('lastBackupTime').innerText = `Backup ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date().toLocaleString()}`;
        document.getElementById('backupAlert').style.display = 'none';
        alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå Backup ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡∏î‡∏µ');
    }

    async function restoreBackup(input) {
        if (!input.files[0]) return;
        if (!confirm("‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: ‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞ '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' ‡πÅ‡∏•‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå Backup\n\n‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
            input.value = '';
            return;
        }
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = JSON.parse(e.target.result);
                await db.items.clear();
                if (data.config) {
                    config = data.config;
                    await db.settings.put({id: "config", data: config});
                }
                if (data.items && data.items.length > 0) {
                    await db.items.bulkAdd(data.items);
                }
                alert(`‚úÖ ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (${data.items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
                location.reload(); 
            } catch (err) {
                alert("‚ùå ‡πÑ‡∏ü‡∏•‡πå Backup ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢");
                console.error(err);
            }
        };
        reader.readAsText(input.files[0]);
    }

    function updateSubOptions() {
        const mainName = document.getElementById('selMain').value;
        const shop = config.shops.find(s => s.name === mainName);
        if(shop) document.getElementById('selSub').innerHTML = shop.subs.map(s => `<option value="${s}">${s}</option>`).join('');
    }

    async function reload() {
        master = await db.items.toArray();
        master.sort((a, b) => new Date(b.uploadDate || 0) - new Date(a.uploadDate || 0));
        render();
    }

    function render() {
        const q = document.getElementById('srch').value.toLowerCase();
        const fShop = document.getElementById('filterShop').value;
        const fDate = document.getElementById('filterDate').value; 
        const fStatus = document.getElementById('filterStatus').value;
        filteredData = master.filter(d => {
            let matchShop = true;
            if (fShop !== 'all') {
                if(fShop.startsWith('MAIN|')) matchShop = d.shopId === fShop.split('|')[1];
                else matchShop = `${d.shopId}|${d.subId}` === fShop;
            }
            let matchDate = true;
            if (fDate) matchDate = (d.uploadDate ? d.uploadDate.split('T')[0] : '') === fDate;
            let matchStatus = true;
            if (fStatus === 'visible') matchStatus = d.isVisible === true;
            if (fStatus === 'hidden') matchStatus = d.isVisible === false;
            const matchSearch = d.name.toLowerCase().includes(q) || d.sku.toLowerCase().includes(q);
            return matchShop && matchDate && matchSearch && matchStatus;
        });
        document.getElementById('displayCount').innerHTML = `üì¶ ‡∏£‡∏ß‡∏°: ${filteredData.length.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        const canvas = document.getElementById('canvas');
        canvas.style.height = (filteredData.length * R_HEIGHT) + 'px';
        canvas.innerHTML = '';
        const scrollTop = document.getElementById('vPort').scrollTop;
        const start = Math.floor(scrollTop / R_HEIGHT);
        const end = Math.min(start + Math.ceil(document.getElementById('vPort').offsetHeight / R_HEIGHT) + 1, filteredData.length);
        for(let i=start; i<end; i++) {
            const item = filteredData[i];
            const gallery = (item.imgs && item.imgs.length > 0) ? item.imgs : [item.mainUrl];
            const galleryStr = JSON.stringify(gallery).replace(/"/g, '&quot;');
            const div = document.createElement('div');
            div.className = `row ${item.isVisible ? '' : 'hidden-item'}`;
            div.style.top = (i * R_HEIGHT) + 'px';
            div.innerHTML = `
                <div style="display:flex; flex-direction:column; align-items:center; margin-right:5px;">
                    <input type="checkbox" style="transform:scale(1.3); margin-bottom:5px;" 
                        ${selectedIds.has(item.id) ? 'checked' : ''} 
                        onchange="toggleSelect(${item.id})">
                    <span style="font-size:9px; color:#999;">${i+1}</span>
                </div>
                <div class="gallery-container">
                    ${gallery.map((url, idx) => `
                        <img src="${url}" class="img-thumb" onclick="openGallery(${galleryStr}, ${idx})" onerror="this.style.display='none'">
                    `).join('')}
                </div>
                <div style="flex:1; min-width:0;">
                    <span class="shop-highlight">${item.shopId} > ${item.subId}</span>
                    <div style="font-size:11px; color:#555; margin-bottom:4px; font-weight:bold;">
                        ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î ${formatDate(item.uploadDate)}
                    </div>
                    <div contenteditable="true" onblur="updateItem(${item.id}, 'name', this.innerText)" 
                        style="font-weight:bold; font-size:14px; margin-bottom:2px; cursor:text; line-height:1.4;">${item.name}</div>
                    <span class="sku-badge" onclick="copySKU('${item.sku}')">üìã ${item.sku}</span>
                    <span style="font-size:10px; color:${item.isVisible?'var(--green)':'var(--red)'}; margin-left:5px;">
                        ${item.isVisible ? '‚óè ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•' : '‚óè ‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà'}
                    </span>
                </div>
                <div style="text-align:right; min-width:110px; display:flex; flex-direction:column; justify-content:space-between; height:100px;">
                    <div contenteditable="true" onblur="updateItem(${item.id}, 'price', this.innerText.replace(/,/g,''))"
                        style="color:var(--red); font-weight:bold; font-size:18px; cursor:text;">
                        ${Number(item.price).toLocaleString()}
                    </div>
                    <button onclick="deleteSingle(${item.id})" style="font-size:11px; color:#888; background:white; border:1px solid #ddd; border-radius:4px; padding:4px; cursor:pointer;">üóëÔ∏è ‡∏•‡∏ö</button>
                </div>
            `;
            canvas.appendChild(div);
        }
    }
    document.getElementById('vPort').onscroll = render;

    function openGallery(imgs, index) {
        currentGalleryImgs = imgs;
        currentImgIndex = index;
        currentZoom = 1;
        updateGalleryView();
        document.getElementById('imgModal').style.display = 'flex';
    }

    function updateGalleryView() {
        const img = document.getElementById('fullImg');
        img.src = currentGalleryImgs[currentImgIndex];
        img.style.transform = `scale(${currentZoom})`;
    }

    function zoomImage(event) {
        event.preventDefault();
        if (event.deltaY < 0) { currentZoom += 0.1; } else { currentZoom -= 0.1; }
        if (currentZoom < 0.5) currentZoom = 0.5;
        if (currentZoom > 5) currentZoom = 5;
        document.getElementById('fullImg').style.transform = `scale(${currentZoom})`;
    }

    function navGallery(direction) {
        currentImgIndex += direction;
        if (currentImgIndex < 0) currentImgIndex = currentGalleryImgs.length - 1;
        if (currentImgIndex >= currentGalleryImgs.length) currentImgIndex = 0;
        currentZoom = 1; 
        updateGalleryView();
    }

    function closeGallery() {
        document.getElementById('imgModal').style.display = 'none';
        currentZoom = 1;
    }

    function doExport() {
        if (filteredData.length === 0) return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏Å‡∏£‡∏≠‡∏á');
        const exportRows = filteredData.map(item => ({
            "‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å": item.shopId,
            "‡∏ä‡πá‡∏≠‡∏õ‡∏¢‡πà‡∏≠‡∏¢": item.subId,
            "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤": item.name,
            "SKU": item.sku,
            "‡∏£‡∏≤‡∏Ñ‡∏≤": item.price,
            "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞": item.isVisible ? "‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•" : "‡∏ã‡πà‡∏≠‡∏ô",
            "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î": formatDate(item.uploadDate),
            "‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å": (item.imgs && item.imgs[0]) ? item.imgs[0] : item.mainUrl,
            "‡∏£‡∏π‡∏õ1": (item.imgs && item.imgs[1]) ? item.imgs[1] : "",
            "‡∏£‡∏π‡∏õ2": (item.imgs && item.imgs[2]) ? item.imgs[2] : "",
            "‡∏£‡∏π‡∏õ3": (item.imgs && item.imgs[3]) ? item.imgs[3] : "",
        }));
        const ws = XLSX.utils.json_to_sheet(exportRows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Stock_Export");
        const d = new Date();
        const fileName = `StockExport_${d.getDate()}-${d.getMonth()+1}_${d.getHours()}-${d.getMinutes()}.xlsx`;
        XLSX.writeFile(wb, fileName);
    }

    function formatDate(isoStr) {
        if(!isoStr) return "-";
        const d = new Date(isoStr);
        return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()} ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
    }
    function copySKU(txt) { navigator.clipboard.writeText(txt); alert('Copy SKU: ' + txt); }

    async function handleImport(input) {
        if(!input.files[0]) return;
        const mainShop = document.getElementById('selMain').value;
        const subShop = document.getElementById('selSub').value;
        const uploadTime = new Date().toISOString();
        const reader = new FileReader();
        reader.onload = async (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type:'array'});
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            const existingUrlMap = new Map();
            const existingSkuMap = new Map();
            master.forEach(i => {
                if(i.mainUrl) existingUrlMap.set(i.mainUrl, i);
                if(i.sku && i.sku !== "N/A") existingSkuMap.set(i.sku, i);
            });
            const duplicates = [];
            const toAdd = [];
            json.forEach(row => {
                const imgList = [row['‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å'], row['‡∏£‡∏π‡∏õ1'], row['‡∏£‡∏π‡∏õ2'], row['‡∏£‡∏π‡∏õ3'], row['‡∏£‡∏π‡∏õ4']].filter(u => u && String(u).trim().length > 0);
                const mainUrl = imgList[0] || "";
                const name = String(row['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] || "").trim();
                if(!name && !mainUrl) return;
                const sku = getSKU(name);
                let isDup = false;
                let dupReason = "";
                let dupOld = null;
                if(mainUrl && existingUrlMap.has(mainUrl)) {
                    isDup = true;
                    dupReason = "‡∏£‡∏π‡∏õ‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö";
                    dupOld = existingUrlMap.get(mainUrl);
                } 
                else if(sku !== "N/A" && existingSkuMap.has(sku)) {
                    isDup = true;
                    dupReason = `‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SKU) ‡∏ã‡πâ‡∏≥: ${sku}`;
                    dupOld = existingSkuMap.get(sku);
                }
                if(isDup) {
                    const oldName = dupOld.name || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠ (‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)";
                    const oldShopLoc = (dupOld.shopId && dupOld.subId) ? `${dupOld.shopId} > ${dupOld.subId}` : "‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô";
                    duplicates.push({ newName: name, oldName: oldName, shopLoc: oldShopLoc, reason: dupReason });
                } else {
                    const newItem = {
                        mainUrl: mainUrl, imgs: imgList, name: name, sku: sku,
                        price: row['‡∏£‡∏≤‡∏Ñ‡∏≤'] || 0, shopId: mainShop, subId: subShop,
                        isVisible: true, uploadDate: uploadTime,
                        sortKey: name.replace(/[^‡∏Å-‡∏Æa-zA-Z0-9]/g, '')
                    };
                    toAdd.push(newItem);
                    syncToSheets(newItem); // <--- ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheets
                    if(mainUrl) existingUrlMap.set(mainUrl, newItem);
                    if(sku !== "N/A") existingSkuMap.set(sku, newItem);
                }
            });
            if(duplicates.length > 0) showDupModal(duplicates);
            if(toAdd.length > 0) { await db.items.bulkAdd(toAdd); reload(); }
            input.value = '';
        };
        reader.readAsArrayBuffer(input.files[0]);
    }
    
    function getSKU(name) {
        const matches = name.match(/\(([^)]+)\)/g);
        if (matches && matches.length > 0) {
            return matches[matches.length - 1].replace(/[()]/g, '').trim();
        }
        const parts = name.trim().split(/\s+/);
        if (parts.length > 0) {
            const lastPart = parts[parts.length - 1];
            if (/^[A-Za-z0-9]+$/.test(lastPart)) return lastPart;
        }
        return "N/A";
    }

    async function updateItem(id, f, v) { await db.items.update(id, { [f]: v }); const i = master.findIndex(x=>x.id===id); if(i>-1) master[i][f]=v; }
    async function bulkDelete() { if(confirm(`‡∏•‡∏ö ${selectedIds.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`)) { await db.items.where('id').anyOf([...selectedIds]).delete(); selectedIds.clear(); reload(); document.getElementById('bulkBar').style.display='none'; document.getElementById('mainSelectAll').checked = false; } }
    async function deleteSingle(id) { if(confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) { await db.items.delete(id); reload(); } }
    
    function showDupModal(l) { 
        document.getElementById('dupSummary').innerText=`‡∏û‡∏ö‡∏ã‡πâ‡∏≥ ${l.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`; 
        document.getElementById('dupList').innerHTML=l.map(d=>`
            <div class="dup-card">
                <div><span class="dup-reason">${d.reason}</span></div>
                <div><strong>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà:</strong> ${d.newName}</div>
                <div style="color:var(--red); margin:5px 0;"><strong>‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö:</strong> ${d.oldName}</div>
                <div style="font-size:12px; color:#555;">üìç ${d.shopLoc}</div>
            </div>`).join(''); 
        document.getElementById('dupModal').style.display='flex'; 
    }

    function openSetup() { document.getElementById('shopManagerList').innerHTML = config.shops.map((s,i)=>`
        <div style="border:1px solid #ddd; padding:5px; margin-bottom:5px;"><b>${s.name}</b> <button onclick="delMain(${i})" style="color:red;border:none;">‡∏•‡∏ö</button>
        <div>${s.subs.map((sub,j)=>`<span style="background:#eee;margin:2px;padding:2px;">${sub} <span onclick="delSub(${i},${j})" style="color:red;cursor:pointer;">x</span></span>`).join('')} <button onclick="addSub(${i})">+</button></div></div>`).join(''); document.getElementById('setupModal').style.display='flex'; }
    async function addMainShop(){ const n=document.getElementById('newMainShop').value; if(n){config.shops.push({name:n,subs:["‡∏ä‡πá‡∏≠‡∏õ 1"]}); await db.settings.put({id:"config",data:config}); openSetup();}}
    async function addSub(i){ const n=prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πá‡∏≠‡∏õ:"); if(n){config.shops[i].subs.push(n); await db.settings.put({id:"config",data:config}); openSetup();}}
    async function delMain(i){ if(confirm("‡∏•‡∏ö‡∏£‡πâ‡∏≤‡∏ô?")) {config.shops.splice(i,1); await db.settings.put({id:"config",data:config}); openSetup();}}
    async function delSub(i,j){ config.shops[i].subs.splice(j,1); await db.settings.put({id:"config",data:config}); openSetup();}
    async function clearDB() { const p = prompt("üîê ‡∏£‡∏´‡∏±‡∏™‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:"); if(p==="9009"){ if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?")){ await db.items.clear(); reload(); }} else if(p!==null) alert("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); }
</script>
</body>
</html>