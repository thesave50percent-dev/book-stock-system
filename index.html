<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÇ‡∏Å‡∏î‡∏±‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ (Pro Sync & Cloud)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>
    <style>
        :root { --red: #d32f2f; --green: #2e7d32; --blue: #1976d2; --bg: #f4f7f6; --dark: #333; --orange: #ff9800; }
        body { font-family: 'Tahoma', sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { background: white; padding: 10px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px dashed #ddd; padding-bottom: 10px; }
        .viewport { flex: 1; overflow-y: auto; background: white; position: relative; }
        .row { display: flex; align-items: flex-start; padding: 10px 15px; border-bottom: 1px solid #eee; transition: 0.2s; height: 140px; position: absolute; width: 100%; box-sizing: border-box; }
        .row:hover { background: #fffdfd; }
        .row.hidden-item { opacity: 0.5; background: #f9f9f9; }
        .gallery-container { display: flex; gap: 5px; overflow-x: auto; max-width: 350px; padding-bottom: 5px; margin-right: 15px; }
        .gallery-container::-webkit-scrollbar { height: 4px; }
        .gallery-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        .img-thumb { min-width: 80px; height: 110px; object-fit: cover; border-radius: 4px; cursor: zoom-in; border: 1px solid #ddd; flex-shrink: 0; }
        .shop-highlight { display: inline-block; background: #e3f2fd; color: #0d47a1; padding: 4px 10px; border-radius: 6px; font-weight: 900; font-size: 14px; border: 1px solid #bbdefb; margin-bottom: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .sku-badge { background: #333; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; cursor: copy; margin-top: 5px; display: inline-block; }
        .count-badge { margin-left: auto; background: var(--blue); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 13px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); white-space: nowrap; }
        .btn { padding: 8px 15px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; font-size: 13px; }
        .btn-red { background: var(--red); color: white; }
        .btn-green { background: var(--green); color: white; }
        .btn-grey { background: #555; color: white; }
        .btn-orange { background: var(--orange); color: white; }
        .btn-blue { background: var(--blue); color: white; } 
        select, input[type="text"], input[type="date"] { padding: 8px; border-radius: 6px; border: 1px solid #ccc; height: 35px; box-sizing: border-box; }
        .filter-bar { display: flex; gap: 10px; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 10px; flex-wrap: wrap; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 700px; padding: 20px; border-radius: 10px; max-height: 85vh; overflow-y: auto; position: relative; }
        .img-viewer-content { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #fullImg { transition: transform 0.1s; max-height: 90vh; max-width: 90vw; border-radius: 5px; cursor: grab; }
        .nav-hint { position: absolute; bottom: 20px; color: white; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; font-size: 12px; pointer-events: none; }
        .bulk-bar { display: none; background: #fff3e0; padding: 8px 15px; border-radius: 8px; align-items: center; gap: 10px; margin-bottom: 5px; border: 1px solid #ffe0b2; }
        .select-all-header { position: sticky; top: 0; background: #fff; z-index: 10; padding: 8px 15px; border-bottom: 1px solid #ddd; font-size: 13px; display: flex; align-items: center; color: #555; font-weight: bold; }
        @media (max-width: 600px) { .filter-bar { justify-content: space-between; } .count-badge { width: 100%; text-align: center; margin-top: 5px; order: 10; } }
    </style>
</head>
<body>

<div id="hiddenMgrModal" class="modal"><div class="modal-content">...</div></div>
<div id="setupModal" class="modal"><div class="modal-content">...</div></div>
<div id="backupModal" class="modal"><div class="modal-content">...</div></div>
<div id="dupModal" class="modal"><div class="modal-content">...</div></div>
<div id="imgModal" class="modal" onclick="closeGallery()"><div class="img-viewer-content" onclick="event.stopPropagation()"><img id="fullImg" onwheel="zoomImage(event)"><div class="nav-hint">üñ±Ô∏è ‡∏ã‡∏π‡∏° | ‚¨ÖÔ∏è ‚û°Ô∏è ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏£‡∏π‡∏õ</div></div></div>

<header>
    <div class="top-bar">
        <div style="display:flex; align-items:center; gap:10px;">
            <h2 style="margin:0; color:var(--dark);">üìö ‡πÇ‡∏Å‡∏î‡∏±‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ Pro</h2>
            <button class="btn btn-blue" onclick="syncFromSheets()">‚òÅÔ∏è ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏à‡∏≤‡∏Å Cloud</button>
            <button class="btn btn-grey" onclick="openSetup()">‚öôÔ∏è ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="doExport()" class="btn btn-green">üì• Excel</button>
            <button onclick="clearDB()" class="btn btn-red">‚ö†Ô∏è ‡∏•‡πâ‡∏≤‡∏á</button>
        </div>
    </div>

    <div id="bulkBar" class="bulk-bar">
        <span id="selCount" style="font-weight:bold;">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
        <button class="btn btn-grey" onclick="bulkVisible(true)">üëÅÔ∏è ‡πÅ‡∏™‡∏î‡∏á</button>
        <button class="btn btn-grey" onclick="bulkVisible(false)">üö´ ‡∏ã‡πà‡∏≠‡∏ô</button>
        <button class="btn btn-red" onclick="bulkDelete()">üóëÔ∏è ‡∏•‡∏ö</button>
    </div>

    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; background:#eee; padding:10px; border-radius:8px;">
        <span style="font-weight:bold; font-size:13px;">üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤:</span>
        <select id="selMain" onchange="updateSubOptions()"></select>
        <select id="selSub"></select>
        <button class="btn btn-red" onclick="document.getElementById('fIn').click()">+ ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</button>
        <input type="file" id="fIn" hidden accept=".xlsx, .xls" onchange="handleImport(this)">
    </div>

    <div class="filter-bar">
        <input type="text" id="srch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠ SKU..." style="flex:1;" oninput="render()">
        <span id="displayCount" class="count-badge">üì¶ ‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î...</span>
    </div>
</header>

<div class="viewport" id="vPort">
    <div class="select-all-header">
        <input type="checkbox" id="mainSelectAll" onchange="toggleSelectAllMain()">
        <label for="mainSelectAll" style="margin-left:10px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
    </div>
    <div id="canvas" style="position:relative;"></div>
</div>

<script>
    // --- ‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ GOOGLE SHEETS ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxNnadJiiwklJQ4k1JWyXHaEBF0lyS1lmzmW8iLud5PYgwqlq30adC8Rw_hfnX-1h43/exec"; 

    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Cloud
    async function syncToSheets(item) {
        try {
            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(item)
            });
            console.log("Synced to Cloud:", item.name);
        } catch (e) { console.error("Sync Push Error:", e); }
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å Cloud
    async function syncFromSheets() {
        if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Cloud ‡∏°‡∏≤‡∏•‡∏á‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
        const btn = document.querySelector('button[onclick="syncFromSheets()"]');
        btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå...";
        btn.disabled = true;

        try {
            const response = await fetch(SCRIPT_URL);
            const data = await response.json();
            if (data && data.length > 0) {
                await db.items.clear();
                await db.items.bulkAdd(data);
                await reload();
                alert("‚úÖ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏û‡∏ö " + data.length + " ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
            } else { alert("‚ùì ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ô Cloud"); }
        } catch (e) {
            alert("‚ùå ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
            console.error(e);
        } finally {
            btn.innerText = "‚òÅÔ∏è ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏à‡∏≤‡∏Å Cloud";
            btn.disabled = false;
        }
    }

    // --- ‡∏£‡∏∞‡∏ö‡∏ö Database & Logic (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    const db = new Dexie("StockWarehouseProV13_HiddenMgr"); 
    db.version(1).stores({ items: "++id, mainUrl, name, sku, shopId, subId, isVisible, uploadDate", settings: "id, data" });

    let master = [];
    let filteredData = []; 
    let selectedIds = new Set();
    const R_HEIGHT = 140;

    window.onload = async () => {
        const savedConfig = await db.settings.get("config");
        config = savedConfig ? savedConfig.data : { shops: [{ name: "‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏î‡∏≠‡∏∞‡πÄ‡∏ã‡∏ü", subs: ["‡∏ä‡πá‡∏≠‡∏õ 1"] }], backupInterval: 0 };
        initUI();
        reload();
    };

    async function reload() { master = await db.items.toArray(); master.sort((a, b) => new Date(b.uploadDate || 0) - new Date(a.uploadDate || 0)); render(); }

    function render() {
        const q = document.getElementById('srch').value.toLowerCase();
        filteredData = master.filter(d => d.name.toLowerCase().includes(q) || d.sku.toLowerCase().includes(q));
        document.getElementById('displayCount').innerText = `üì¶ ‡∏£‡∏ß‡∏°: ${filteredData.length.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        const canvas = document.getElementById('canvas');
        canvas.style.height = (filteredData.length * R_HEIGHT) + 'px';
        canvas.innerHTML = '';
        
        const scrollTop = document.getElementById('vPort').scrollTop;
        const start = Math.floor(scrollTop / R_HEIGHT);
        const end = Math.min(start + 10, filteredData.length);

        for(let i=start; i<end; i++) {
            const item = filteredData[i];
            const div = document.createElement('div');
            div.className = `row ${item.isVisible ? '' : 'hidden-item'}`;
            div.style.top = (i * R_HEIGHT) + 'px';
            div.innerHTML = `
                <input type="checkbox" ${selectedIds.has(item.id) ? 'checked' : ''} onchange="toggleSelect(${item.id})">
                <img src="${item.mainUrl}" class="img-thumb" style="margin: 0 10px;">
                <div style="flex:1;">
                    <span class="shop-highlight">${item.shopId}</span>
                    <div style="font-weight:bold;">${item.name}</div>
                    <div class="sku-badge">${item.sku}</div>
                </div>
                <div style="color:var(--red); font-weight:bold; font-size:18px;">‡∏ø${Number(item.price).toLocaleString()}</div>
            `;
            canvas.appendChild(div);
        }
    }
    document.getElementById('vPort').onscroll = render;

    async function handleImport(input) {
        if(!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type:'array'});
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            const toAdd = json.map(row => {
                const item = {
                    name: row['‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'], sku: row['SKU'] || 'N/A', price: row['‡∏£‡∏≤‡∏Ñ‡∏≤'],
                    mainUrl: row['‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å'], shopId: document.getElementById('selMain').value,
                    subId: document.getElementById('selSub').value, isVisible: true, uploadDate: new Date().toISOString()
                };
                syncToSheets(item); // ‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô Cloud ‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                return item;
            });
            await db.items.bulkAdd(toAdd);
            reload();
        };
        reader.readAsArrayBuffer(input.files[0]);
    }

    function initUI() {
        document.getElementById('selMain').innerHTML = config.shops.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        updateSubOptions();
    }
    function updateSubOptions() {
        const shop = config.shops.find(s => s.name === document.getElementById('selMain').value);
        document.getElementById('selSub').innerHTML = shop.subs.map(s => `<option value="${s}">${s}</option>`).join('');
    }
    function toggleSelect(id) { selectedIds.has(id) ? selectedIds.delete(id) : selectedIds.add(id); render(); }
</script>
</body>
</html>
